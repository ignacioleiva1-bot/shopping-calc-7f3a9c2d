<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shopping USA - Calc</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --muted:#8ea0c0;
      --text:#e9f0ff;
      --accent:#2dd4bf;
      --danger:#fb7185;
      --border: rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--font);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(45,212,191,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(99,102,241,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 820px; margin: 0 auto; padding: 18px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 6px 0 12px; }
    h1{ font-size: 22px; margin:0; letter-spacing:.2px; }
    .pill{ font-size:14px; color:var(--muted); border:1px solid var(--border); padding:8px 12px; border-radius:999px; white-space: nowrap; }

    .modeBar{ display:flex; justify-content:center; margin: 10px 0 14px; }
    .seg{
      display:flex;
      width: min(420px, 100%);
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px;
      box-shadow: var(--shadow);
      gap: 6px;
    }
    .seg input{
      position:absolute; width:1px; height:1px; overflow:hidden;
      clip: rect(1px, 1px, 1px, 1px); white-space: nowrap;
    }
    .seg label{
      margin:0; flex:1; text-align:center; padding: 10px 12px; border-radius: 999px;
      font-size: 15px; color: rgba(233,240,255,.85); cursor:pointer; user-select:none;
      border: 1px solid transparent;
      transition: background .15s ease, border-color .15s ease, color .15s ease;
    }
    .seg input:checked + label{
      background: linear-gradient(135deg, rgba(45,212,191,.26), rgba(99,102,241,.14));
      border-color: rgba(45,212,191,.35);
      color: #eafffb;
      font-weight: 800;
    }

    .grid{ display:grid; gap:12px; }
    @media(min-width:820px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .card{
      background: rgba(15,26,46,.92);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 14px;
      backdrop-filter: blur(8px);
    }
    .card h2{ margin: 0 0 10px; font-size: 17px; color: #d6e3ff; }

    label{ display:block; font-size:14px; color: var(--muted); margin: 12px 0 7px; line-height: 1.2; }

    input, select{
      width:100%;
      padding: 14px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      font-size: 18px;
      -webkit-appearance: none;
      appearance: none;
    }
    input:focus, select:focus{
      border-color: rgba(45,212,191,.55);
      box-shadow: 0 0 0 4px rgba(45,212,191,.12);
    }

    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }

    .btns{ display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
    button{
      border:0;
      padding: 14px 14px;
      border-radius: 12px;
      font-weight: 750;
      letter-spacing:.2px;
      cursor:pointer;
      color:#001014;
      background: var(--accent);
      font-size: 17px;
      flex: 1 1 160px;
    }
    .ghost{ background: transparent; color: var(--text); border:1px solid var(--border); font-weight:700; }
    .danger{ background: rgba(251,113,133,.12); color: #ffd7dd; border:1px solid rgba(251,113,133,.25); }

    .kpi{ display:flex; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid var(--border); align-items: baseline; }
    .kpi:last-child{ border-bottom:0; }
    .kpi .name{ color: var(--muted); font-size: 14px; }
    .kpi .val{ font-variant-numeric: tabular-nums; font-size: 17px; }

    .kpi.total{
      margin-top: 8px;
      padding: 14px 12px;
      border-radius: 14px;
      border: 1px solid rgba(45,212,191,.40);
      background: linear-gradient(135deg, rgba(45,212,191,.20), rgba(99,102,241,.12));
    }
    .kpi.total .name{ color: #dffcf7; font-weight: 800; font-size: 14px; letter-spacing: .2px; }
    .kpi.total .val{ font-size: 24px; font-weight: 900; color: #eafffb; }

    .small{ font-size: 14px; color: var(--muted); margin-top: 8px; line-height: 1.5; }
    .err{ color: var(--danger); font-size: 14px; margin-top: 10px; display:none; }
    .hidden{ display:none !important; }

    .cartList{ display:flex; flex-direction:column; gap:10px; margin-top: 12px; }
    .cartItem{ border:1px solid var(--border); border-radius: 14px; padding: 12px; background: rgba(255,255,255,.03); }
    .cartTop{ display:flex; justify-content:space-between; gap: 10px; align-items:flex-start; }
    .cartTitle{ font-weight: 850; line-height: 1.2; font-size: 16px; margin: 0; }
    .cartMeta{ color: var(--muted); font-size: 13px; margin-top: 6px; line-height: 1.25; }
    .cartActions{ display:flex; gap:8px; flex-wrap: wrap; justify-content:flex-end; align-items:center; }
    .miniBtn{ padding: 10px 12px; border-radius: 12px; font-size: 14px; font-weight: 800; flex: 0 0 auto; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Shopping USA - Calculadora</h1>
      <div class="pill">¡a reventar la billetera!</div>
    </header>

    <div class="modeBar">
      <div class="seg" role="tablist" aria-label="Modo">
        <input type="radio" name="mode" id="mode_ind" value="individual" checked>
        <label for="mode_ind">Individual</label>

        <input type="radio" name="mode" id="mode_cart" value="cart">
        <label for="mode_cart">Carrito</label>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="leftCard">
        <h2 id="leftTitle">Precio y descuentos</h2>

        <div id="panelIndividual">
          <label>Importe (USD)</label>
          <input id="usd" type="number" inputmode="decimal" step="0.01" placeholder="Ej: 150" />

          <div class="row">
            <div>
              <label>Descuento: sobre el artículo (%)</label>
              <input id="d1" type="number" inputmode="decimal" step="0.01" placeholder="Ej: 50" />
            </div>
            <div>
              <label>Descuento: sobre el total de la factura (%)</label>
              <input id="d2" type="number" inputmode="decimal" step="0.01" placeholder="Ej: 20" />
            </div>
          </div>

          <label>Impuesto / Sales tax (%)</label>
          <input id="tax" type="number" inputmode="decimal" step="0.01" value="6.5" />

          <div class="btns">
            <button type="button" id="calcBtn">Calcular</button>
            <button type="button" class="ghost" id="clearBtn">Limpiar</button>
          </div>

          <div class="err" id="err"></div>
        </div>

        <div id="panelCart" class="hidden">
          <label>Descuento: sobre el total de la factura (%)</label>
          <input id="cartBillDiscount" type="number" inputmode="decimal" step="0.01" placeholder="Ej: 20" />

          <label>Impuesto / Sales tax (%)</label>
          <input id="cartTax" type="number" inputmode="decimal" step="0.01" value="6.5" />

          <hr style="border:0;border-top:1px solid var(--border); margin: 14px 0;">

          <h2 style="margin-top:0;">Agregar / editar ítem</h2>

          <label>Descripción</label>
          <input id="itemDesc" type="text" placeholder="Ej: Zapatillas Nike" />

          <div class="row">
            <div>
              <label>Precio unitario (USD)</label>
              <input id="itemUsd" type="number" inputmode="decimal" step="0.01" placeholder="Ej: 120" />
            </div>
            <div>
              <label>Cantidad</label>
              <input id="itemQty" type="number" inputmode="numeric" step="1" value="1" />
            </div>
          </div>

          <label>Descuento: sobre el artículo (%)</label>
          <input id="itemDisc" type="number" inputmode="decimal" step="0.01" placeholder="Ej: 50" />

          <div class="btns">
            <button type="button" id="addItemBtn">Agregar al carrito</button>
            <button type="button" class="ghost" id="cancelEditBtn">Cancelar edición</button>
          </div>

          <div class="btns">
            <button type="button" class="ghost" id="recalcCartBtn">Recalcular carrito</button>
            <button type="button" class="danger miniBtn" id="clearCartBtn">Vaciar carrito</button>
          </div>

          <div class="err" id="cartErr"></div>

          <div class="cartList" id="cartList"></div>
        </div>
      </div>

      <div class="card">
        <h2>Resultados</h2>
        <div id="results">
          <div class="kpi"><div class="name">USD original</div><div class="val" id="r_usd0">—</div></div>
          <div class="kpi"><div class="name">USD con descuentos</div><div class="val" id="r_usdDisc">—</div></div>
          <div class="kpi"><div class="name">Impuesto (USD)</div><div class="val" id="r_taxUsd">—</div></div>

          <div class="kpi total"><div class="name">Total final (USD)</div><div class="val" id="r_totalUsd">—</div></div>

          <div class="kpi"><div class="name">Total en pesos (ARS)</div><div class="val" id="r_arsSelected">—</div></div>
          <div class="kpi"><div class="name">Tipo de cambio usado</div><div class="val" id="r_rateUsed">—</div></div>
        </div>

        <div class="small" id="ratesInfo">Tipos de cambio: —</div>
        <div class="small" id="ratesStatus"></div>

        <hr style="border:0;border-top:1px solid var(--border); margin: 14px 0;">

        <h2 style="margin:0 0 10px;">Tipo de cambio</h2>

        <label>Usar para el cálculo</label>
        <select id="rateMode">
          <option value="blue" selected>Blue (default)</option>
          <option value="mep">MEP</option>
          <option value="oficial">Oficial</option>
        </select>

        <div class="row" style="margin-top: 10px;">
          <div>
            <label>Oficial</label>
            <input id="rateOf" type="number" inputmode="decimal" step="0.01" placeholder="Cargando..." />
          </div>
          <div>
            <label>Blue</label>
            <input id="rateBl" type="number" inputmode="decimal" step="0.01" placeholder="Cargando..." />
          </div>
        </div>

        <label>MEP</label>
        <input id="rateMep" type="number" inputmode="decimal" step="0.01" placeholder="Cargando..." />

        <div class="btns">
          <button type="button" id="refreshRatesBtn">Actualizar</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const fmtUsd = (n) => isFinite(n) ? n.toLocaleString("en-US", { style:"currency", currency:"USD" }) : "—";
  const fmtArs = (n) => isFinite(n) ? n.toLocaleString("es-AR", { style:"currency", currency:"ARS", maximumFractionDigits: 0 }) : "—";

  const KEY_RATES = "shopping_calc_rates_v8";
  const KEY_MODE  = "shopping_calc_rate_mode_v1";
  const KEY_UI_MODE = "shopping_calc_ui_mode_v1";
  const KEY_CART = "shopping_calc_cart_v4";

  let memRates = null;
  let autoSaveTimer = null;

  let cart = [];
  let cartEditingId = null;

  function uuid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }

  function showErr(elId, msg){
    const el = $(elId);
    if(!msg){ el.style.display = "none"; el.textContent = ""; return; }
    el.style.display = "block";
    el.textContent = msg;
  }

  function setStatus(msg){ $("ratesStatus").textContent = msg || ""; }

  function readNum(id){
    const v = parseFloat($(id).value);
    return isFinite(v) ? v : 0;
  }

  // ---- Rates ----
  function getRates(){
    try{
      const data = localStorage.getItem(KEY_RATES);
      if(!data) return memRates;
      return JSON.parse(data);
    } catch { return memRates; }
  }
  function setRates(r){
    memRates = r;
    try{ localStorage.setItem(KEY_RATES, JSON.stringify(r)); } catch {}
  }
  function renderRatesInfo(){
    const r = getRates();
    $("ratesInfo").textContent = r ? `Oficial ${r.oficial} · Blue ${r.blue} · MEP ${r.mep}` : "Tipos de cambio: (sin datos aún)";
  }
  function ratesFromInputs(){
    const oficial = parseFloat($("rateOf").value);
    const blue = parseFloat($("rateBl").value);
    const mep = parseFloat($("rateMep").value);
    if(!isFinite(oficial) || !isFinite(blue) || !isFinite(mep)) return null;
    return { oficial, blue, mep };
  }
  function pushRatesToInputs(r){
    $("rateOf").value = r?.oficial ?? "";
    $("rateBl").value = r?.blue ?? "";
    $("rateMep").value = r?.mep ?? "";
  }
  function loadRateMode(){
    try{ $("rateMode").value = localStorage.getItem(KEY_MODE) || "blue"; }
    catch { $("rateMode").value = "blue"; }
  }
  function persistRateMode(mode){
    try{ localStorage.setItem(KEY_MODE, mode); } catch {}
  }
  function pickRate(rates, mode){
    if(!rates) return { label: "—", value: NaN };
    if(mode === "oficial") return { label: "Oficial", value: Number(rates.oficial) };
    if(mode === "mep") return { label: "MEP", value: Number(rates.mep) };
    return { label: "Blue", value: Number(rates.blue) };
  }
  function formatUpdateStamp(isoString){
    const d = new Date(isoString);
    if(isNaN(d.getTime())) return null;
    return d.toLocaleString("es-AR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit", hourCycle:"h23" });
  }
  async function fetchOne(endpoint){
    const url = `https://dolarapi.com/v1/dolares/${endpoint}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }
  async function refreshRatesFromInternet(){
    setStatus("Actualizando tipo de cambio...");
    try{
      const [of, bl, mep] = await Promise.all([ fetchOne("oficial"), fetchOne("blue"), fetchOne("bolsa") ]);
      const rates = { oficial: Number(of.venta), blue: Number(bl.venta), mep: Number(mep.venta) };
      if(!isFinite(rates.oficial) || !isFinite(rates.blue) || !isFinite(rates.mep)) throw new Error("Bad numbers");

      pushRatesToInputs(rates);
      setRates(rates);
      renderRatesInfo();

      const iso = bl.fechaActualizacion || of.fechaActualizacion || mep.fechaActualizacion;
      const stamp = formatUpdateStamp(iso);
      setStatus(stamp ? `Tipo de cambio actualizado al ${stamp}` : "Tipo de cambio actualizado");

      recalcActiveMode();
    } catch {
      setStatus("No se pudo actualizar (quedaron los valores previos).");
    }
  }
  function scheduleAutoSaveRates(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
      const r = ratesFromInputs();
      if(!r) return;
      setRates(r);
      renderRatesInfo();
      recalcActiveMode();
    }, 350);
  }

  // ---- Shared totals render ----
  function renderTotals({ usd0, usdAfterDiscounts, taxUsd, totalUsd }){
    $("r_usd0").textContent = fmtUsd(usd0);
    $("r_usdDisc").textContent = fmtUsd(usdAfterDiscounts);
    $("r_taxUsd").textContent = fmtUsd(taxUsd);
    $("r_totalUsd").textContent = fmtUsd(totalUsd);

    const rates = getRates();
    const mode = $("rateMode").value || "blue";
    const picked = pickRate(rates, mode);

    if(isFinite(picked.value)){
      $("r_arsSelected").textContent = fmtArs(totalUsd * picked.value);
      $("r_rateUsed").textContent = `${picked.label} (${picked.value})`;
    } else {
      $("r_arsSelected").textContent = "—";
      $("r_rateUsed").textContent = "—";
    }
  }

  // ---- Individual ----
  function computeIndividual(){
    showErr("err", "");

    const usd0 = readNum("usd");
    const d1 = readNum("d1");
    const d2 = readNum("d2");
    const tax = readNum("tax");

    if(usd0 <= 0){ showErr("err","Ingresá un importe USD mayor que 0."); return; }
    if(d1 < 0 || d2 < 0 || tax < 0){ showErr("err","Descuentos e impuesto no pueden ser negativos."); return; }

    const usdAfterD1 = usd0 * (1 - d1/100);
    const usdAfterD2 = usdAfterD1 * (1 - d2/100);
    const taxUsd = usdAfterD2 * (tax/100);
    const totalUsd = usdAfterD2 + taxUsd;

    renderTotals({ usd0, usdAfterDiscounts: usdAfterD2, taxUsd, totalUsd });
  }

  // ---- Cart persistence ----
  function loadCart(){
    try{
      const raw = localStorage.getItem(KEY_CART);
      if(!raw) return;
      const data = JSON.parse(raw);
      cart = Array.isArray(data?.items) ? data.items : [];
      if(isFinite(Number(data?.billDiscount))) $("cartBillDiscount").value = data.billDiscount;
      if(isFinite(Number(data?.tax))) $("cartTax").value = data.tax;
    } catch { cart = []; }
  }
  function saveCart(){
    try{
      const data = { items: cart, billDiscount: readNum("cartBillDiscount"), tax: readNum("cartTax") };
      localStorage.setItem(KEY_CART, JSON.stringify(data));
    } catch {}
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // ---- Pro-rate logic ----
  function calcCartLinesWithProration(){
    const lines = cart.map(it => {
      const qty = Number(it.qty)||0;
      const unit = Number(it.usd)||0;
      const disc = Number(it.disc)||0;
      const unitAfterItemDisc = unit * (1 - disc/100);
      const lineNet = unitAfterItemDisc * qty;
      return { id: it.id, desc: it.desc || "Ítem", qty, unit, disc, unitAfterItemDisc, lineNet };
    });

    const subtotal = lines.reduce((s,l) => s + l.lineNet, 0);

    const billDiscPct = readNum("cartBillDiscount");
    const billDiscTotal = subtotal * (billDiscPct/100);

    const prorated = lines.map(l => {
      const weight = subtotal > 0 ? (l.lineNet / subtotal) : 0;
      const billDiscAllocated = billDiscTotal * weight;
      const lineAfterBillDisc = l.lineNet - billDiscAllocated;
      const unitEffective = l.qty > 0 ? (lineAfterBillDisc / l.qty) : 0;
      return { ...l, billDiscAllocated, lineAfterBillDisc, unitEffective };
    });

    return { lines: prorated, subtotal, billDiscTotal, afterBill: subtotal - billDiscTotal };
  }

  function renderCartList(){
    const list = $("cartList");
    list.innerHTML = "";

    if(cart.length === 0){
      const empty = document.createElement("div");
      empty.className = "small";
      empty.textContent = "Carrito vacío. Agregá un ítem arriba.";
      list.appendChild(empty);
      return;
    }

    const billDiscPct = readNum("cartBillDiscount");
    const { lines } = calcCartLinesWithProration();

    lines.forEach(l => {
      const el = document.createElement("div");
      el.className = "cartItem";

      const itemDiscPct = Number(l.disc) || 0;

      const step1 = `${l.qty} × ${fmtUsd(l.unit)}`;

      // Si NO hay descuento ítem: omitimos este paso entero (no mostramos "→ $90.00")
      const step2 = (itemDiscPct > 0)
        ? `${fmtUsd(l.unitAfterItemDisc)} (${itemDiscPct}%)`
        : "";

      // Si NO hay descuento factura: omitimos este paso entero (no mostramos "→ $60.00")
      const step3 = (billDiscPct > 0)
        ? `${fmtUsd(l.unitEffective)} (${billDiscPct}%)`
        : "";

      // armamos solo con los pasos que existan y unimos con flechitas [web:254][web:258]
      const detail = [step1, step2, step3].filter(Boolean).join(" → ");

      el.innerHTML = `
        <div class="cartTop">
          <div style="min-width:0;">
            <div class="cartTitle">${escapeHtml(l.desc)}</div>
            <div class="cartMeta">${detail}</div>
          </div>
          <div class="cartActions">
            <button class="ghost miniBtn" data-action="edit" data-id="${l.id}">Editar</button>
            <button class="miniBtn danger" data-action="del" data-id="${l.id}">Eliminar</button>
          </div>
        </div>
      `;
      list.appendChild(el);
    });
  }

  function startEditItem(id){
    const it = cart.find(x => x.id === id);
    if(!it) return;
    cartEditingId = id;
    $("itemDesc").value = it.desc || "";
    $("itemUsd").value = it.usd ?? "";
    $("itemQty").value = it.qty ?? 1;
    $("itemDisc").value = it.disc ?? "";
    $("addItemBtn").textContent = "Guardar cambios";
  }

  function cancelEdit(){
    cartEditingId = null;
    $("itemDesc").value = "";
    $("itemUsd").value = "";
    $("itemQty").value = 1;
    $("itemDisc").value = "";
    $("addItemBtn").textContent = "Agregar al carrito";
  }

  function upsertItemFromForm(){
    showErr("cartErr", "");

    const desc = $("itemDesc").value.trim();
    const usd = parseFloat($("itemUsd").value);
    const qty = parseInt($("itemQty").value, 10);
    const disc = parseFloat($("itemDisc").value);

    if(!desc){ showErr("cartErr", "Poné una descripción (aunque sea corta)."); return; }
    if(!isFinite(usd) || usd <= 0){ showErr("cartErr", "Precio unitario USD inválido."); return; }
    if(!Number.isInteger(qty) || qty <= 0){ showErr("cartErr", "Cantidad inválida."); return; }
    const discOk = isFinite(disc) ? disc : 0;
    if(discOk < 0){ showErr("cartErr", "Descuento del artículo no puede ser negativo."); return; }

    if(cartEditingId){
      const it = cart.find(x => x.id === cartEditingId);
      if(it){ it.desc = desc; it.usd = usd; it.qty = qty; it.disc = discOk; }
    } else {
      cart.push({ id: uuid(), desc, usd, qty, disc: discOk });
    }

    saveCart();
    renderCartList();
    recalcCart();
    cancelEdit();
  }

  function deleteItem(id){
    cart = cart.filter(x => x.id !== id);
    saveCart();
    renderCartList();
    recalcCart();
    if(cartEditingId === id) cancelEdit();
  }

  function clearCart(){
    cart = [];
    saveCart();
    renderCartList();
    recalcCart();
    cancelEdit();
  }

  function recalcCart(){
    showErr("cartErr", "");

    const billDiscount = readNum("cartBillDiscount");
    const tax = readNum("cartTax");
    if(billDiscount < 0 || tax < 0){ showErr("cartErr", "Descuento factura e impuesto no pueden ser negativos."); return; }

    const usd0 = cart.reduce((sum, it) => sum + (Number(it.usd)||0) * (Number(it.qty)||0), 0);

    const { afterBill } = calcCartLinesWithProration();
    const usdAfterDiscounts = afterBill;

    const taxUsd = usdAfterDiscounts * (tax/100);
    const totalUsd = usdAfterDiscounts + taxUsd;

    renderTotals({ usd0, usdAfterDiscounts, taxUsd, totalUsd });
    saveCart();
  }

  // ---- UI mode ----
  function setUiMode(mode){
    const isCart = mode === "cart";
    $("panelIndividual").classList.toggle("hidden", isCart);
    $("panelCart").classList.toggle("hidden", !isCart);
    $("leftTitle").textContent = isCart ? "Carrito" : "Precio y descuentos";
    try { localStorage.setItem(KEY_UI_MODE, mode); } catch {}
    recalcActiveMode();
  }
  function loadUiMode(){
    try{
      const m = localStorage.getItem(KEY_UI_MODE) || "individual";
      if(m === "cart"){ $("mode_cart").checked = true; setUiMode("cart"); }
      else { $("mode_ind").checked = true; setUiMode("individual"); }
    } catch { setUiMode("individual"); }
  }
  function recalcActiveMode(){
    const mode = $("mode_cart").checked ? "cart" : "individual";
    if(mode === "cart"){ renderCartList(); recalcCart(); }
  }

  // ---- Wiring ----
  $("mode_ind").addEventListener("change", () => setUiMode("individual"));
  $("mode_cart").addEventListener("change", () => setUiMode("cart"));

  $("calcBtn").addEventListener("click", computeIndividual);
  $("clearBtn").addEventListener("click", () => {
    $("usd").value = ""; $("d1").value = ""; $("d2").value = "";
    showErr("err", "");
    $("r_usd0").textContent = $("r_usdDisc").textContent = $("r_taxUsd").textContent = $("r_totalUsd").textContent = "—";
    $("r_arsSelected").textContent = "—";
    $("r_rateUsed").textContent = "—";
  });

  $("addItemBtn").addEventListener("click", upsertItemFromForm);
  $("cancelEditBtn").addEventListener("click", cancelEdit);
  $("recalcCartBtn").addEventListener("click", () => { renderCartList(); recalcCart(); });
  $("clearCartBtn").addEventListener("click", clearCart);

  $("cartBillDiscount").addEventListener("input", () => { saveCart(); renderCartList(); recalcCart(); });
  $("cartTax").addEventListener("input", () => { saveCart(); recalcCart(); });

  $("cartList").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action]");
    if(!btn) return;
    const id = btn.getAttribute("data-id");
    const action = btn.getAttribute("data-action");
    if(action === "edit") startEditItem(id);
    if(action === "del") deleteItem(id);
  });

  $("rateMode").addEventListener("change", (e) => { persistRateMode(e.target.value); recalcActiveMode(); });
  $("refreshRatesBtn").addEventListener("click", refreshRatesFromInternet);
  ["rateOf","rateBl","rateMep"].forEach(id => $(id).addEventListener("input", scheduleAutoSaveRates));

  // ---- Init ----
  loadRateMode();
  loadCart();
  renderCartList();
  renderRatesInfo();
  loadUiMode();

  const savedRates = getRates();
  if(savedRates) pushRatesToInputs(savedRates);

  refreshRatesFromInternet();
</script>
</body>
</html>
